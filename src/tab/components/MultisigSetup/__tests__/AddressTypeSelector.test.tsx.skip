/**
 * AddressTypeSelector Component Test Suite
 *
 * Comprehensive tests for the AddressTypeSelector component covering:
 * - Initial rendering and layout
 * - Address type selection (P2WSH, P2SH-P2WSH, P2SH)
 * - Fee level indicators
 * - Recommended badge
 * - P2SH warning modal
 * - Expand/collapse functionality
 * - Continue button state
 * - Callback invocation
 *
 * Total Tests: 18
 * Priority: P1 - Critical wizard step
 */

import React from 'react';
import { screen, waitFor } from '@testing-library/react';
import '@testing-library/jest-dom';
import { renderWithProviders, userEvent } from '../../__tests__/testUtils';
import AddressTypeSelector from '../AddressTypeSelector';
import { MultisigAddressType } from '../../../../shared/types';

// Mock Modal component
jest.mock('../../shared/Modal', () => ({
  __esModule: true,
  default: ({ isOpen, onClose, children }: any) =>
    isOpen ? React.createElement('div', { 'data-testid': 'modal' }, children) : null,
}));

describe('AddressTypeSelector', () => {
  const mockOnSelect = jest.fn();
  const mockOnContinue = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  // ==================== RENDERING ====================

  describe('Rendering', () => {
    it('renders header and description', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('Choose Address Type')).toBeInTheDocument();
      expect(screen.getByText('Select how your multisig addresses will be formatted on the blockchain')).toBeInTheDocument();
    });

    it('renders all 3 address type cards', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('P2WSH - Native SegWit')).toBeInTheDocument();
      expect(screen.getByText('P2SH-P2WSH - Wrapped SegWit')).toBeInTheDocument();
      expect(screen.getByText('P2SH - Legacy')).toBeInTheDocument();
    });

    it('shows recommended badge on P2WSH', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('â­')).toBeInTheDocument();
      expect(screen.getByText('Recommended')).toBeInTheDocument();
    });

    it('displays fee levels for each type', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('Lowest Fees')).toBeInTheDocument();
      expect(screen.getByText('Lower Fees')).toBeInTheDocument();
      expect(screen.getByText('Higher Fees')).toBeInTheDocument();
    });

    it('shows compatibility tags', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('Modern')).toBeInTheDocument();
      expect(screen.getByText('Good Compatibility')).toBeInTheDocument();
      expect(screen.getByText('Maximum Compatibility')).toBeInTheDocument();
    });

    it('shows address prefixes', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText(/tb1q\.\.\. \(testnet\)/)).toBeInTheDocument();
      expect(screen.getByText(/2\.\.\. \(testnet\)/)).toBeInTheDocument();
      expect(screen.getByText(/3\.\.\. \(testnet\)/)).toBeInTheDocument();
    });

    it('shows info boxes', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.getByText('All co-signers must use the SAME address type')).toBeInTheDocument();
      expect(screen.getByText('Recommended Choice')).toBeInTheDocument();
    });
  });

  // ==================== SELECTION ====================

  describe('Selection', () => {
    it('calls onSelect when P2WSH card is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2WSH - Native SegWit').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      expect(mockOnSelect).toHaveBeenCalledWith('p2wsh');
    });

    it('calls onSelect when P2SH-P2WSH card is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2SH-P2WSH - Wrapped SegWit').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      expect(mockOnSelect).toHaveBeenCalledWith('p2sh-p2wsh');
    });

    it('shows warning modal when P2SH card is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2SH - Legacy').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      await waitFor(() => {
        expect(screen.getByTestId('modal')).toBeInTheDocument();
        expect(screen.getByText('Are you sure?')).toBeInTheDocument();
      });
    });

    it('does not select P2SH when modal is cancelled', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2SH - Legacy').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /go back/i })).toBeInTheDocument();
      });

      await userEvent.click(screen.getByRole('button', { name: /go back/i }));

      await waitFor(() => {
        expect(screen.queryByTestId('modal')).not.toBeInTheDocument();
      });

      expect(mockOnSelect).not.toHaveBeenCalledWith('p2sh');
    });

    it('selects P2SH when modal is confirmed', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2SH - Legacy').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /continue anyway/i })).toBeInTheDocument();
      });

      await userEvent.click(screen.getByRole('button', { name: /continue anyway/i }));

      expect(mockOnSelect).toHaveBeenCalledWith('p2sh');
    });

    it('shows selected state on P2WSH when selected', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={'p2wsh' as MultisigAddressType}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2WSH - Native SegWit').closest('div[class*="rounded-2xl"]');
      expect(card).toHaveClass('border-bitcoin');
    });

    it('does not show modal when clicking already selected P2SH', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={'p2sh' as MultisigAddressType}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const card = screen.getByText('P2SH - Legacy').closest('div[class*="rounded-2xl"]');
      await userEvent.click(card!);

      expect(screen.queryByTestId('modal')).not.toBeInTheDocument();
      expect(mockOnSelect).toHaveBeenCalledWith('p2sh');
    });
  });

  // ==================== EXPAND/COLLAPSE ====================

  describe('Expand/Collapse', () => {
    it('shows collapsed state initially', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      expect(screen.queryByText('Advantages:')).not.toBeInTheDocument();
    });

    it('expands when Learn more button is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const learnMoreButtons = screen.getAllByText('Learn more');
      await userEvent.click(learnMoreButtons[0]);

      await waitFor(() => {
        expect(screen.getByText('Advantages:')).toBeInTheDocument();
        expect(screen.getByText('Considerations:')).toBeInTheDocument();
      });
    });

    it('collapses when Show less is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const learnMoreButtons = screen.getAllByText('Learn more');
      await userEvent.click(learnMoreButtons[0]);

      await waitFor(() => {
        expect(screen.getByText('Advantages:')).toBeInTheDocument();
      });

      const showLessButton = screen.getByText('Show less');
      await userEvent.click(showLessButton);

      await waitFor(() => {
        expect(screen.queryByText('Advantages:')).not.toBeInTheDocument();
      });
    });

    it('stops propagation when Learn more is clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
        />
      );

      const learnMoreButtons = screen.getAllByText('Learn more');
      await userEvent.click(learnMoreButtons[0]);

      // onSelect should not be called
      expect(mockOnSelect).not.toHaveBeenCalled();
    });
  });

  // ==================== CONTINUE BUTTON ====================

  describe('Continue Button', () => {
    it('is disabled when no type is selected', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
          showContinueButton={true}
        />
      );

      const continueButton = screen.getByRole('button', { name: /continue/i });
      expect(continueButton).toBeDisabled();
    });

    it('is enabled when a type is selected', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={'p2wsh' as MultisigAddressType}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
          showContinueButton={true}
        />
      );

      const continueButton = screen.getByRole('button', { name: /continue/i });
      expect(continueButton).toBeEnabled();
    });

    it('calls onContinue when clicked', async () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={'p2wsh' as MultisigAddressType}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
          showContinueButton={true}
        />
      );

      const continueButton = screen.getByRole('button', { name: /continue/i });
      await userEvent.click(continueButton);

      expect(mockOnContinue).toHaveBeenCalledTimes(1);
    });

    it('does not render button when showContinueButton is false', () => {
      renderWithProviders(
        <AddressTypeSelector
          selectedAddressType={undefined}
          onSelect={mockOnSelect}
          onContinue={mockOnContinue}
          showContinueButton={false}
        />
      );

      expect(screen.queryByRole('button', { name: /continue/i })).not.toBeInTheDocument();
    });
  });
});
